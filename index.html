<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line Rider in Augmented Reality</title>
    <link rel="shortcut icon" type="image/png" href="res/LineRiderCharacter-Rotated.png" />

    <script src="online-scripts/three.101.min.js"></script>
    <script src="online-scripts/THREEAR.js"></script>

    <!-- anime.js: import anime module separately, as AFRAME.ANIME doesn't seem to work well -->
    <script src="online-scripts/anime.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script> -->

    <script src="my-scripts/sceneLoad.js"></script>
    <script src="my-scripts/getCorners.js"></script>
    <script src="my-scripts/imageProcessing.js"></script>

    <script>
        const pageSetupParams = {
            // marker location relative to TOP LEFT of draw area (x, z, -y)
            markerCenterX: 0.5,
            markerCenterY: 0.5,
            markerCenterZ: 0.0,
            markerSide: 1,
            // draw area in units relative to marker side
            drawAreaW: 3,
            drawAreaH: 5,
            // margin (% of marker side) around draw area to ignore
            drawAreaBorderPercent: 10
        };

        const processingParams = {
            // canny edge detection
            canny_low_threshold: 20,
            canny_high_threshold: 50,
            // dilation and erosion
            dilateKernel: 5,
            erodeKernel: 7, // 3
            dilateIters: 1,
            erodeIters: 1 // 3
        };

        // boolean flag for loading of OpenCV
        var openCVReady = false;

        // function isMobile() {
        //     try { document.createEvent("TouchEvent"); return true; }
        //     catch (e) { return false; }
        // }

        function onOpenCVReady() {
            cv['onRuntimeInitialized'] = async () => {
                // notify that OpenCV is ready
                console.log("OpenCV loaded!");
                // set flag to true
                openCVReady = true;
            }
        }

        function ensureOpenCVReady() {
            return new Promise(function (resolve, reject) {
                (function waitForOpenCVReady() {
                    if (openCVReady) return resolve();
                    setTimeout(waitForOpenCVReady, 30);
                })();
            });
        }

        window.onload = function () {

            loadScene().then((sceneInit) => {

                const { controller, marker, camera } = sceneInit;

                const button = document.querySelector("#action-button");
                const video = document.querySelector("video");
                const liveCanvas = document.querySelector("#live-canvas");

                fnFound = () => {
                    button.style.pointerEvents = "auto";
                    button.textContent = "Start Action";
                    controller.removeEventListener("markerFound", fnFound);
                }

                fnLost = () => {
                    button.style.pointerEvents = "none";
                    button.textContent = "Marker Not Found";
                    controller.addEventListener("markerFound", fnFound);
                }

                controller.addEventListener("markerFound", fnFound);
                controller.addEventListener("markerLost", fnLost);

                ensureOpenCVReady().then(() => {

                    let cornersClass = new Corners(pageSetupParams, marker, camera);
                    let imageProcessingClass = new ImageProcessing(processingParams, pageSetupParams, video, liveCanvas);

                    function processPage() {
                        if (marker.found) {
                            let sourceCorners = cornersClass.getCorners({ videoWidth: video.videoWidth, videoHeight: video.videoHeight });
                            imageProcessingClass.imageProcessing(sourceCorners);
                        }
                        else { console.log("Marker not found") }
                    }

                    // setInterval(processPage, 1000 / 2);

                    //     // // animation
                    //     // function animation() {
                    //     //     anime({
                    //     //         // (x, z, -y)
                    //     //         targets: cube.position,
                    //     //         keyframes: [
                    //     //             { x: "1.5", y: "0.5", z: "0" },
                    //     //             { x: "1.5", y: "0.5", z: "1.5" },
                    //     //             { x: "0", y: "0.5", z: "1.5" },
                    //     //             { x: "0", y: "0.5", z: "0" }
                    //     //         ],
                    //     //         easing: "linear",
                    //     //         duration: 2000
                    //     //     });
                    //     // }

                    button.addEventListener("click", function () {

                        // animate
                        // animation();

                        // image processing
                        processPage();
                    });
                });
            });
        }

    </script>

    <!-- OpenCV.js: import script locally instead of pulling from internet (to avoid download limit) -->
    <script async onload="onOpenCVReady()" src="online-scripts/opencv.js"></script>
    <!-- <script src="https://docs.opencv.org/master/opencv.js"></script> -->

    <style>
        .buttons {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5em;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .action-button {
            padding: 0.25em;
            border-radius: 4px;
            border: none;
            background: white;
            color: black;
            width: 6em;
            height: 4em;
        }
    </style>

</head>

<body style='margin: 0px; overflow: hidden;'>

    <div class="buttons">
        <button id="action-button" style="pointer-events: none">Marker Not Found</button>
    </div>

    <canvas id="live-canvas" position="absolute" z-index="10" style="background-color: gray"></canvas>

</body>

</html>